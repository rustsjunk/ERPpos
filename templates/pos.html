<!DOCTYPE html>
<html lang="en" data-qz-certificate="{{ qz_certificate or '' }}" data-qz-private-key="{{ qz_private_key or '' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERPNext POS</title>
    <link rel="icon" href="data:,">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', v='6') }}">
    
    <!-- Optional: ensure UTF-8 is respected -->
</head>
<body>
    <div class="app-topbar">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <div class="brand h5 m-0">POS</div>
            </div>
            <div></div>
            <div class="d-flex align-items-center gap-2">
                <label for="topCustomerSelect" class="visually-hidden">Customer</label><select id="topCustomerSelect" aria-label="Customer" class="customer-select form-select form-select-sm">
                </select>
                <div class="cashier-wrap">
                    <button id="cashierBadge" class="cashier-badge btn btn-light btn-sm">Not signed in</button>
                    <div id="cashierMenu" class="cashier-menu">
                        <button id="holdBtn" class="btn btn-outline-secondary w-100 mb-2">Hold Transaction</button>
                        <button id="pausedBtn" class="btn btn-outline-primary w-100 mb-2">Paused Transactions</button>
                        <button id="logoutBtn" class="logout-btn">Log Out</button>
                    </div>
                </div>
                <button id="returnFromReceiptBtn" aria-label="Return from receipt" class="return-cta" title="Return from receipt">? Return by Receipt</button>
                <button id="notifIcon" aria-label="Notifications" class="notif-icon" title="Notifications">&#128276;</button>
                <button id="settingsBtn" aria-label="Settings" class="icon-btn" title="Settings">&#9881;</button>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row pos-layout">
            <!-- Left side - Items list -->
            <div class="col-md-8">
                <div class="row mb-3">
                    <div class="col">
                        <input type="text" id="itemSearch" aria-label="Search items" class="form-control" placeholder="Search items...">
                    </div>
                </div>
                <div id="itemsGrid" class="row row-cols-1 row-cols-md-3 g-4">
                    <!-- Items will be dynamically added here -->
                </div>
            </div>
            
            <!-- Right side - Cart -->
            <div class="col-md-4 cart-column">
                <div id="cartCard" class="card">
                    <div class="card-header">
                        <h3>Current Cart</h3>
                    </div>
                    <div class="card-body">
                        <div id="cartItems">
                            <!-- Cart items will be dynamically added here -->
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>Total:</h5>
                            <h5 id="cartTotal">0.00</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Removed fixed barcode bar; compact entry lives under cart actions -->

    <!-- Product Search Overlay -->
    <div id="searchOverlay" class="search-overlay">
        <div class="search-modal">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <input type="text" id="searchInputBig" aria-label="Search products" class="form-control me-2" placeholder="Search products..." />
                <label for="brandFilter" class="visually-hidden">Brand filter</label><select id="brandFilter" aria-label="Brand filter" class="form-select" style="max-width:220px"></select>
            </div>
            <div id="searchGrid" class="row row-cols-2 row-cols-md-4 g-3"></div>
            <div class="d-flex justify-content-end mt-3">
                <button id="searchCloseBtn" class="btn btn-outline-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Product Detail Overlay (variant matrix) -->
    <div id="productOverlay" class="search-overlay">
        <div class="search-modal">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0" id="productTitle">Product</div>
                <button id="productCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <div id="productImage" class="product-img"></div>
                    <div id="productBrand" class="mt-2 text-muted"></div>
                    <div id="productPrice" class="fw-semibold mt-1"></div>
                </div>
                <div class="col-12 col-md-8">
                    <div class="table-responsive variant-matrix">
                        <table class="table table-sm align-middle">
                            <thead id="matrixHead"></thead>
                            <tbody id="matrixBody"></tbody>
                        </table>
                    </div>
                    <div class="text-muted small">Click a size cell to add 1 to cart.</div></div></div></div>
    </div>

    <!-- Checkout Overlay -->
    <div id="checkoutOverlay" class="search-overlay">
        <div class="search-modal checkout-modal">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Checkout</div>
                <button id="checkoutCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div class="row g-3">
                <div class="col-12 col-lg-7">
                    <div id="checkoutCart" class="checkout-cart"></div>
                    <div class="mt-3">
                        <div class="mb-2 fw-semibold">Tender Type</div>
                        <div class="tender-grid mb-3">
                            <button id="tenderCashBtn" class="btn tender-btn" data-tender="cash">Cash</button>
                            <button class="btn tender-btn" data-tender="card">Card</button>
                            <button id="tenderVoucherBtn" class="btn tender-btn" data-tender="voucher">Voucher</button>
                            <button class="btn tender-btn" data-tender="other">Other</button>
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="fw-semibold">Applied Payments</div>
                                <div id="paymentsTotal" class="fw-semibold text-end"></div>
                            </div>
                            <div id="appliedPaymentsList" class="applied-payments-list"></div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-5">
                    <div class="tender-panel">
                        <div id="cashSection" class="mb-3" style="display:none;">
                            <div id="cashKeypad" class="keypad-grid compact mt-2" style="display:block;">
                                <button class="key-btn" data-k="7">7</button>
                                <button class="key-btn" data-k="8">8</button>
                                <button class="key-btn" data-k="9">9</button>
                                <button class="key-btn" data-k="4">4</button>
                                <button class="key-btn" data-k="5">5</button>
                                <button class="key-btn" data-k="6">6</button>
                                <button class="key-btn" data-k="1">1</button>
                                <button class="key-btn" data-k="2">2</button>
                                <button class="key-btn" data-k="3">3</button>
                                <button class="key-btn key-action" data-k="C">C</button>
                                <button class="key-btn" data-k="0">0</button>
                                <button class="key-btn key-action" data-k="B">&#x232B;</button>
                            </div>
                            <div id="cashSummaryData" class="d-none" aria-hidden="true">
                                <div id="amountDue"></div>
                                <div id="amountCash"></div>
                                <div id="amountCashEntered"></div>
                                <div id="amountChange"></div>
                            </div>
                            <div class="cash-controls mt-2 d-flex flex-wrap gap-2 align-items-center justify-content-end">
                                <button id="toggleSubtractBtn" class="btn btn-outline-warning btn-sm">- Mode</button>
                                <input type="number" step="0.01" id="cashInputField" class="form-control form-control-sm" placeholder="Enter cash amount" style="max-width: 160px;" />
                                <button id="toggleKeypadBtn" class="btn btn-outline-secondary btn-sm">Show Keypad</button>
                                <button id="convertToEuroBtn" class="btn btn-info btn-sm" title="Convert due amount to EUR and pay in Euros">&euro; Convert</button>
                                <button id="addPlasticBagBtn" class="btn btn-outline-primary btn-sm" type="button" title="Add a plastic bag to this sale">+ Plastic Bag</button>
                                <button id="clearCashBtn" class="btn btn-outline-danger btn-sm">Clear</button>
                                <button id="applyCashBtn" class="btn btn-primary btn-sm">Apply Cash</button>
                            </div>

                        </div>
                        <div id="otherSection" class="mb-3" style="display:none;">
                            <div id="otherKeypad" class="keypad-grid compact mt-2" style="display:block;">
                                <button class="key-btn" data-k="7">7</button>
                                <button class="key-btn" data-k="8">8</button>
                                <button class="key-btn" data-k="9">9</button>
                                <button class="key-btn" data-k="4">4</button>
                                <button class="key-btn" data-k="5">5</button>
                                <button class="key-btn" data-k="6">6</button>
                                <button class="key-btn" data-k="1">1</button>
                                <button class="key-btn" data-k="2">2</button>
                                <button class="key-btn" data-k="3">3</button>
                                <button class="key-btn key-action" data-k="C">C</button>
                                <button class="key-btn" data-k="0">0</button>
                                <button class="key-btn key-action" data-k="B">&#x232B;</button>
                            </div>
                            <div class="cash-summary mt-2">
                                <div class="d-flex justify-content-between">
                                    <div>Due</div>
                                    <div id="amountDueOther" class="fw-semibold"></div>
                                </div>
                            </div>
                            <div class="input-group mt-2" style="max-width: 420px; margin-left:auto;">
                                <span id="otherLabel" class="input-group-text">Amount</span>
                                <input type="number" step="0.01" id="otherAmountInput" class="form-control form-control-sm" placeholder="0.00" />
                                <button id="otherFullAmountBtn" class="btn btn-outline-secondary btn-sm" type="button" title="Fill remaining due">Remaining Amount</button>
                                <button id="applyOtherBtn" class="btn btn-primary btn-sm" type="button">Apply</button>
                            </div>
                        </div>
                        <div class="d-grid gap-2 tender-actions">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="fw-semibold text-muted">Remaining Due</div>
                                <div id="tenderDue" class="fw-bold"></div>
                            </div>
                            <button id="openDiscountBtn" class="btn btn-outline-secondary">Discount</button>
                            <button id="completeSaleBtn" class="btn btn-success btn-lg">Complete Sale</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- EUR Converter Overlay -->
    <div id="eurConverterOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal eur-overlay-modal">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <div class="h5 mb-1">Accept Euro Cash</div>
                    <div id="eurOverlayStatus" class="text-muted small">Select a rate option to begin.</div>
                </div>
                <button id="eurOverlayCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div class="eur-overlay-grid">
                <div class="eur-overlay-left">
                    <div class="eur-overview">
                        <div class="eur-overview-row">
                            <div>
                                <small class="text-uppercase text-muted fw-semibold">GBP Total</small>
                                <div id="eurOverlayGbpTotal" class="eur-figure text-dark">&pound;0.00</div>
                            </div>
                            <div>
                                <small class="text-uppercase text-muted fw-semibold">Store Rate (1 GBP)</small>
                                <div id="eurOverlayStoreRate" class="eur-figure text-primary">1.0000 EUR</div>
                            </div>
                        </div>
                        <p class="text-muted small mb-0">Choose the EUR target, then enter how many euros the customer hands over.</p>
                    </div>
                    <div class="eur-option-row compact">
                        <button type="button" class="eur-option-card" data-eur-option="exact">
                            <span class="eur-option-title">Actual</span>
                            <span class="eur-option-amount" id="eurOverlayExact">&euro;0.00</span>
                            <span class="eur-option-note">No rounding</span>
                        </button>
                        <button type="button" class="eur-option-card" data-eur-option="down">
                            <span class="eur-option-title">Round down</span>
                            <span class="eur-option-amount" id="eurOverlayRoundDown">&euro;0.00</span>
                            <span class="eur-option-note">Nearest &euro;5 below</span>
                        </button>
                        <button type="button" class="eur-option-card" data-eur-option="up">
                            <span class="eur-option-title">Round up</span>
                            <span class="eur-option-amount" id="eurOverlayRoundUp">&euro;0.00</span>
                            <span class="eur-option-note">Nearest &euro;5 above</span>
                        </button>
                    </div>
                    <div class="eur-selection-summary">
                        <div>
                            <small class="text-muted text-uppercase fw-semibold">Expected EUR</small>
                            <div id="eurExpectedAmount" class="eur-figure-sm">--</div>
                        </div>
                        <div>
                            <small class="text-muted text-uppercase fw-semibold">Effective rate</small>
                            <div id="eurEffectiveRateDisplay" class="eur-figure-sm">1 GBP = -- EUR</div>
                        </div>
                    </div>
                </div>
                <div class="eur-overlay-right">
                    <div class="eur-keypad-panel">
                        <div class="eur-keypad" id="eurKeypad">
                            <button type="button" class="key-btn" data-k="1">1</button>
                            <button type="button" class="key-btn" data-k="2">2</button>
                            <button type="button" class="key-btn" data-k="3">3</button>
                            <button type="button" class="key-btn" data-k="4">4</button>
                            <button type="button" class="key-btn" data-k="5">5</button>
                            <button type="button" class="key-btn" data-k="6">6</button>
                            <button type="button" class="key-btn" data-k="7">7</button>
                            <button type="button" class="key-btn" data-k="8">8</button>
                            <button type="button" class="key-btn" data-k="9">9</button>
                            <button type="button" class="key-btn key-action" data-k="C">C</button>
                            <button type="button" class="key-btn" data-k="0">0</button>
                            <button type="button" class="key-btn key-action" data-k="B">Back</button>
                        </div>
                    </div>
                    <div class="eur-entry-panel">
                        <label class="form-label text-uppercase small fw-semibold">Enter EUR received</label>
                        <div class="input-group eur-input-group">
                            <span class="input-group-text">&euro;</span>
                            <input type="text" id="eurReceivedInput" class="form-control" inputmode="decimal" autocomplete="off" value="0.00">
                            <button type="button" class="btn btn-outline-secondary" id="eurUseExpectedBtn">Use expected</button>
                        </div>
                    </div>
                    <div class="eur-summary-panel">
                        <div class="eur-diff-card">
                            <div class="text-muted text-uppercase small fw-semibold">Status</div>
                            <div id="eurDifferenceStatus" class="eur-diff-status">Select a rate to continue.</div>
                        </div>
                        <div class="eur-diff-card">
                            <div class="text-muted text-uppercase small fw-semibold">Sterling impact</div>
                            <div id="eurSterlingImpact" class="eur-diff-sterling">--</div>
                        </div>
                        <div class="eur-diff-card">
                            <div class="text-muted text-uppercase small fw-semibold">Applied equivalent</div>
                            <div id="eurActualGbp" class="eur-diff-sterling">&euro;0.00 &asymp; &pound;0.00</div>
                        </div>
                        <button type="button" id="eurApplyBtn" class="btn btn-primary btn-lg w-100 mt-3" disabled>Apply EUR Tender</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt / Print Overlay -->
    <div id="receiptOverlay" class="search-overlay">
        <div class="search-modal receipt-modal">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Sale Complete</div>
                <button id="receiptCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div class="mb-2">Receipt: <span id="receiptInvoice"></span></div>
            <div class="display-6 mb-3">Change: <span id="receiptChange">0.00</span></div>
            <p class="text-muted">Would you like to print the receipt?</p>
            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="giftReceiptCheckbox">
                <label class="form-check-label" for="giftReceiptCheckbox">Also print gift receipt</label>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-3">
                <button id="printReceiptBtn" class="btn btn-primary">Print Receipt</button>
                <button id="receiptReturnBtn" class="btn btn-outline-warning">Return This Receipt</button>
                <button id="receiptDoneBtn" class="btn btn-success">Done</button>
            </div>
        </div>
    </div>

    <!-- Menu Overlay -->
    <div id="menuOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 520px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Menu</div>
                <button id="menuCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div id="menuView">
                <div class="d-grid gap-2">
                    <button id="openSettingsBtn" class="btn btn-light">Settings</button>
                    <button id="openCashMenuBtn" class="btn btn-light">Opening / Closing</button>
                    <button id="reprintLastBtn" class="btn btn-light">Reprint Last Receipt</button>
                    <button id="viewInvoicesBtn" class="btn btn-light">View Receipts</button>
                    <button id="openAdminBtn" class="btn btn-light">Admin</button>
                </div>
            </div>
            <!-- Cash menu overlay -->
            <div id="cashMenuOverlay" class="search-overlay" style="display:none;">
                <div class="search-modal" style="max-width: 420px;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="h5 m-0">Till Menu</div>
                        <button id="cashMenuCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
                    </div>
                    <div class="d-grid gap-2">
                        <button id="cashMenuXReadBtn" class="btn btn-outline-primary">X-Read (view/print)</button>
                        <button id="cashMenuZReadBtn" class="btn btn-primary">Z-Read (end session)</button>
                        <button id="cashMenuOpenBtn" class="btn btn-outline-secondary">Opening Float</button>
                        <button id="cashMenuFloatBtn" class="btn btn-outline-secondary">Closing / Reconcile</button>
                    </div>
                </div>
            </div>
                <div id="settingsView" style="display:none;">
                <div class="mb-3">
                    <label for="tillNumberInput" class="form-label">Till Number</label>
                    <input type="text" id="tillNumberInput" class="form-control" placeholder="e.g. TILL-01">
                </div>
                <div class="mb-3">
                    <label for="branchNameInput" class="form-label">Branch</label>
                    <input type="text" id="branchNameInput" class="form-control" placeholder="e.g. Main Street">
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label for="vatRateInput" class="form-label">VAT Rate (%)</label>
                        <input type="number" step="0.1" min="0" id="vatRateInput" class="form-control" placeholder="e.g. 20">
                    </div>
                    <div class="col-6 d-flex align-items-end">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="vatInclusiveSwitch">
                            <label class="form-check-label" for="vatInclusiveSwitch">Prices include VAT</label>
                        </div>
                    </div>
                </div>
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="darkModeSwitch">
                    <label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
                </div>
                <div class="form-check form-switch mb-4">
                    <input class="form-check-input" type="checkbox" id="autoPrintSwitch">
                    <label class="form-check-label" for="autoPrintSwitch">Auto-print after sale</label>
                </div>
                <div class="form-check form-switch mb-4">
                    <input class="form-check-input" type="checkbox" id="openDrawerSwitch" checked>
                    <label class="form-check-label" for="openDrawerSwitch">Pop cash drawer after receipt</label>
                </div>
                <div class="mb-3">
                    <label for="receiptHeaderInput" class="form-label">Receipt Header</label>
                    <textarea id="receiptHeaderInput" class="form-control" rows="3" placeholder="Russells of Omagh&#10;123 Main Street&#10;Tel: 028 0000 0000"></textarea>
                    <div class="form-text">Shown at the top of each receipt (supports multiple lines).</div>
                </div>
                <div class="mb-4">
                    <label for="receiptFooterInput" class="form-label">Receipt Footer</label>
                    <textarea id="receiptFooterInput" class="form-control" rows="3" placeholder="Thank you for shopping with us!&#10;Keep your receipt for 30 days."></textarea>
                    <div class="form-text">Shown at the bottom (ideal for promos, return policies, etc.).</div>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <button id="settingsBackBtn" class="btn btn-outline-secondary">Back</button>
                    <button id="settingsSaveBtn" class="btn btn-primary">Save</button>
                </div>
            </div>
            <div id="adminView" style="display:none;">
                <div class="mb-2 h6">Admin Tools</div>
                <div class="small text-muted mb-2">Database and sync maintenance</div>
                <div class="d-grid gap-2 mb-3">
                    <button id="adminInitDbBtn" class="btn btn-outline-danger">Initialize Database (schema)</button>
                    <button id="adminSeedBtn" class="btn btn-outline-primary">Seed Demo Items</button>
                    <button id="adminEnsureBtn" class="btn btn-outline-secondary">Ensure Demo DB (init if empty)</button>
                    <button id="adminSyncBtn" class="btn btn-outline-success">Resync from ERPNext</button>
                    <button id="adminStatusBtn" class="btn btn-outline-dark">DB Status</button>
                </div>
                <pre id="adminStatusOut" class="p-2 bg-light" style="max-height: 220px; overflow: auto;"></pre>
                <div class="d-flex justify-content-end gap-2 mt-2">
                    <button id="adminBackBtn" class="btn btn-outline-secondary">Back</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Closing Menu Overlay (viewer/printer) -->
    <div id="closingMenuOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 720px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Closing Summary</div>
                <button id="closingMenuCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div id="closingMenuBody" class="mb-3 small"></div>
            <div class="d-flex justify-content-end gap-2">
                <button id="closingMenuReprintBtn" class="btn btn-primary">Reprint Z-read</button>
            </div>
        </div>
    </div>
    <!-- Opening Float Overlay -->
    <div id="openingOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 520px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Set Opening Float</div>
                <button id="openingCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <p class="text-muted">Enter the total opening cash float for today.</p>
            <div class="input-group mb-3">
                <span class="input-group-text">Amount</span>
                <input type="number" step="0.01" id="openingFloatInput" class="form-control" placeholder="e.g. 150.00" />
            </div>
            <div id="openingKeypad" class="keypad-grid mb-3">
                <button class="key-btn" data-k="7">7</button>
                <button class="key-btn" data-k="8">8</button>
                <button class="key-btn" data-k="9">9</button>
                <button class="key-btn" data-k="4">4</button>
                <button class="key-btn" data-k="5">5</button>
                <button class="key-btn" data-k="6">6</button>
                <button class="key-btn" data-k="1">1</button>
                <button class="key-btn" data-k="2">2</button>
                <button class="key-btn" data-k="3">3</button>
                <button class="key-btn key-action" data-k="C">C</button>
                <button class="key-btn" data-k="0">0</button>
                <button class="key-btn key-action" data-k="B">&#x232B;</button>
            </div>
            <div class="d-flex justify-content-end gap-2">
                <button id="openingSaveBtn" class="btn btn-primary">Save Opening</button>
            </div>
        </div>
    </div>

    <!-- Closing / Reconciliation Overlay -->
    <div id="closingOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 960px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">End of Day Reconciliation</div>
                <button id="closingCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div class="row g-3">
                <div class="col-12 col-lg-7">
                    <div class="card p-3">
                        <div class="fw-semibold mb-2">Denominations</div>
                        <div id="denomsGrid" class="row g-2">
                            <!-- Denomination controls: readonly qty with +1 / -1 buttons -->
                            <div class="col-6 col-md-4"><label class="form-label">Ã‚Â£50</label><div class="input-group input-group-sm"><button class="btn btn-outline-danger sub-denom" data-denom="50" type="button">-1</button><input data-denom="50" type="number" min="0" step="1" class="form-control form-control-sm denom-qty" placeholder="qty" readonly><button class="btn btn-outline-secondary add-denom" data-denom="50" type="button">+1</button></div></div>
                            <div class="col-6 col-md-4"><label class="form-label">Ã‚Â£20</label><div class="input-group input-group-sm"><button class="btn btn-outline-danger sub-denom" data-denom="20" type="button">-1</button><input data-denom="20" type="number" min="0" step="1" class="form-control form-control-sm denom-qty" placeholder="qty" readonly><button class="btn btn-outline-secondary add-denom" data-denom="20" type="button">+1</button></div></div>
                            <div class="col-6 col-md-4"><label class="form-label">Ã‚Â£10</label><div class="input-group input-group-sm"><button class="btn btn-outline-danger sub-denom" data-denom="10" type="button">-1</button><input data-denom="10" type="number" min="0" step="1" class="form-control form-control-sm denom-qty" placeholder="qty" readonly><button class="btn btn-outline-secondary add-denom" data-denom="10" type="button">+1</button></div></div>
                            <div class="col-6 col-md-4"><label class="form-label">Ã‚Â£5</label><div class="input-group input-group-sm"><button class="btn btn-outline-danger sub-denom" data-denom="5" type="button">-1</button><input data-denom="5" type="number" min="0" step="1" class="form-control form-control-sm denom-qty" placeholder="qty" readonly><button class="btn btn-outline-secondary add-denom" data-denom="5" type="button">+1</button></div></div>
                            <div class="col-6 col-md-4"><label class="form-label">Ã‚Â£2</label><div class="input-group input-group-sm"><button class="btn btn-outline-danger sub-denom" data-denom="2" type="button">-1</button><input data-denom="2" type="number" min="0" step="1" class="form-control form-control-sm denom-qty" placeholder="qty" readonly><button class="btn btn-outline-secondary add-denom" data-denom="2" type="button">+1</button></div></div>
                            <div class="col-6 col-md-4"><label class="form-label">Ã‚Â£1</label><div class="input-group input-group-sm"><button class="btn btn-outline-danger sub-denom" data-denom="1" type="button">-1</button><input data-denom="1" type="number" min="0" step="1" class="form-control form-control-sm denom-qty" placeholder="qty" readonly><button class="btn btn-outline-secondary add-denom" data-denom="1" type="button">+1</button></div></div>
                            <div class="col-6 col-md-4"><label class="form-label">50p</label><div class="input-group input-group-sm"><button class="btn btn-outline-danger sub-denom" data-denom="0.5" type="button">-1</button><input data-denom="0.5" type="number" min="0" step="1" class="form-control form-control-sm denom-qty" placeholder="qty" readonly><button class="btn btn-outline-secondary add-denom" data-denom="0.5" type="button">+1</button></div></div>
                            <div class="col-6 col-md-4"><label class="form-label">20p</label><div class="input-group input-group-sm"><button class="btn btn-outline-danger sub-denom" data-denom="0.2" type="button">-1</button><input data-denom="0.2" type="number" min="0" step="1" class="form-control form-control-sm denom-qty" placeholder="qty" readonly><button class="btn btn-outline-secondary add-denom" data-denom="0.2" type="button">+1</button></div></div>
                            <div class="col-6 col-md-4"><label class="form-label">10p</label><div class="input-group input-group-sm"><button class="btn btn-outline-danger sub-denom" data-denom="0.1" type="button">-1</button><input data-denom="0.1" type="number" min="0" step="1" class="form-control form-control-sm denom-qty" placeholder="qty" readonly><button class="btn btn-outline-secondary add-denom" data-denom="0.1" type="button">+1</button></div></div>
                            <div class="col-6 col-md-4"><label class="form-label">5p</label><div class="input-group input-group-sm"><button class="btn btn-outline-danger sub-denom" data-denom="0.05" type="button">-1</button><input data-denom="0.05" type="number" min="0" step="1" class="form-control form-control-sm denom-qty" placeholder="qty" readonly><button class="btn btn-outline-secondary add-denom" data-denom="0.05" type="button">+1</button></div></div>
                            <div class="col-6 col-md-4"><label class="form-label">2p</label><div class="input-group input-group-sm"><button class="btn btn-outline-danger sub-denom" data-denom="0.02" type="button">-1</button><input data-denom="0.02" type="number" min="0" step="1" class="form-control form-control-sm denom-qty" placeholder="qty" readonly><button class="btn btn-outline-secondary add-denom" data-denom="0.02" type="button">+1</button></div></div>
                            <div class="col-6 col-md-4"><label class="form-label">1p</label><div class="input-group input-group-sm"><button class="btn btn-outline-danger sub-denom" data-denom="0.01" type="button">-1</button><input data-denom="0.01" type="number" min="0" step="1" class="form-control form-control-sm denom-qty" placeholder="qty" readonly><button class="btn btn-outline-secondary add-denom" data-denom="0.01" type="button">+1</button></div></div>
                        </div>
                        <div class="mt-2 small text-muted">Tip: enter quantities; totals are calculated automatically.</div>
                    </div>
                </div>
                <div class="col-12 col-lg-5">
                    <div class="card p-3">
                        <div class="fw-semibold mb-2">Summary</div>
                        <div id="reconSummary" style="display:none;">
                            <div class="d-flex justify-content-between"><div>Opening Float</div><div id="sumOpening">Ã‚Â£0.00</div></div>
                            <div class="d-flex justify-content-between"><div>Cash Sales (net)</div><div id="sumCashSales">Ã‚Â£0.00</div></div>
                            <div class="d-flex justify-content-between"><div>Card Sales (net)</div><div id="sumCardSales">Ã‚Â£0.00</div></div>
                            <div class="d-flex justify-content-between"><div>Payouts</div><div>
                                <input type="number" step="0.01" id="sumPayoutsInput" class="form-control form-control-sm" placeholder="0.00" style="max-width: 140px;">
                            </div></div>
                            <hr>
                            <div class="d-flex justify-content-between"><div>Expected Till</div><div id="sumExpected">Ã‚Â£0.00</div></div>
                            <div class="d-flex justify-content-between"><div>Counted (denoms)</div><div id="sumCounted">Ã‚Â£0.00</div></div>
                            <div class="d-flex justify-content-between fw-semibold"><div>Variance</div><div id="sumVariance">Ã‚Â£0.00</div></div>
                        </div>
                        <div id="reconResult" class="mt-2" style="display:none;"></div>
                        <div class="d-grid mt-3">
                            <button id="reconcileBtn" class="btn btn-primary">Enter</button>
                            <button id="reconConfirmBtn" class="btn btn-outline-success" style="display:none;">Confirm and Print</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cash Management Menu (front menu for Opening/Closing) -->
    <div id="cashMenuOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 520px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Cash Management</div>
                <button id="cashMenuCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div class="d-grid gap-2">
                <button id="cashMenuOpenBtn" class="btn btn-light">Opening Float</button>
            </div>
            <hr>
            <div class="mb-2 fw-semibold">Closing</div>
            <div class="d-grid gap-2">
                <button id="cashMenuZReadBtn" class="btn btn-light">Z-Read (Summary/Print)</button>
                <button id="cashMenuFloatBtn" class="btn btn-light">Closing Float (Denominations)</button>
            </div>
        </div>
    </div>

    <!-- Paused Transactions Overlay -->
    <div id="pausedOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 800px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Paused Transactions</div>
                <button id="pausedCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div class="table-responsive" style="overflow:auto;">
                <table class="table table-sm align-middle">
                    <thead>
                        <tr>
                            <th>Held At</th>
                            <th>Cashier</th>
                            <th>Customer</th>
                            <th class="text-end">Items</th>
                            <th class="text-end">Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="pausedListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    
    <!-- Invoices Overlay -->
    <div id="invoicesOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 900px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-2">
                    <div class="h5 m-0">Receipts</div>
                    <input type="date" id="invoiceDateInput" class="form-control form-control-sm" style="max-width: 180px;" />
                </div>
                <button id="invoicesCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div class="table-responsive" style="overflow:auto; max-height:60vh;">
                <table class="table table-sm align-middle">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Source</th>
                            <th>Status</th>
                            <th>Receipt ID</th><th>Customer</th><th>Cashier</th><th class="text-end">Total</th><th>Action</th></tr>
                    </thead>
                    <tbody id="invoicesListBody"></tbody>
                </table>
            </div>
        </div>
    
    <!-- Receipt Detail Overlay -->
    <div id="invoiceDetailOverlay" class="search-overlay" style="display:none;">
      <div class="search-modal" style="max-width: 900px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="h5 m-0" id="invDetailTitle">Receipt</div>
          <div class="d-flex align-items-center gap-2">
            <button id="invDetailReturnBtn" class="btn btn-outline-warning btn-sm">Return This Receipt</button>
            <button id="invDetailCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
          </div>
        </div>
        <div id="invDetailMeta" class="small text-muted mb-2"></div>
        <div class="row g-3">
          <div class="col-12 col-lg-7">
            <div class="list-group" id="invDetailItems" style="max-height: 50vh; overflow:auto;"></div>
          </div>
          <div class="col-12 col-lg-5">
            <div class="card p-3">
              <div class="fw-semibold mb-2">Payments</div>
              <div id="invDetailPayments" class="small"></div>
              <hr>
              <div class="d-flex justify-content-between">
                <div class="fw-semibold">Total</div>
                <div id="invDetailTotal" class="fw-bold"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div></div><!-- Discount Overlay -->
    <div id="discountOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 1000px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Apply Discount</div>
                <button id="discountCloseBtn" class="btn btn-outline-secondary btn-sm">Done</button>
            </div>
            <div class="row g-3">
                <div class="col-12 col-lg-7">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="small text-muted">Select items to discount</div>
                        <div class="btn-group btn-group-sm">
                            <button id="discountSelectAllBtn" class="btn btn-outline-secondary">Select All</button>
                            <button id="discountDeselectAllBtn" class="btn btn-outline-secondary">Deselect All</button>
                        </div>
                    </div>
                    <div id="discountItemsList" class="list-group" style="max-height: 50vh; overflow:auto;"></div>
                </div>
                <div class="col-12 col-lg-5">
                    <div class="card p-3">
                        <div class="mb-2 fw-semibold">Discount Type</div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="discountMode" id="discModeAmount" value="amount" checked>
                            <label class="form-check-label" for="discModeAmount">Amount off (per item)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="discountMode" id="discModePercent" value="percent">
                            <label class="form-check-label" for="discModePercent">Percent off (per item)</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="discountMode" id="discModeSet" value="set">
                            <label class="form-check-label" for="discModeSet">Set unit price</label>
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="discountValueLabel">Value</span>
                            <input type="number" step="0.01" id="discountValueInput" class="form-control" placeholder="e.g. 5.00 or 10 for %">
                        </div>
                        <div id="discountKeypad" class="keypad-grid mb-3">
                            <button class="key-btn" data-k="7">7</button>
                            <button class="key-btn" data-k="8">8</button>
                            <button class="key-btn" data-k="9">9</button>
                            <button class="key-btn" data-k="4">4</button>
                            <button class="key-btn" data-k="5">5</button>
                            <button class="key-btn" data-k="6">6</button>
                            <button class="key-btn" data-k="1">1</button>
                            <button class="key-btn" data-k="2">2</button>
                            <button class="key-btn" data-k="3">3</button>
                            <button class="key-btn key-action" data-k="C">C</button>
                            <button class="key-btn" data-k="0">0</button>
                            <button class="key-btn" data-k=".">.</button>
                        </div>
                        <div class="d-grid">
                            <button id="applyDiscountBtn" class="btn btn-primary">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Return From Receipt Overlay -->
    <div id="returnOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 620px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Return From Receipt</div>
                <button id="returnCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <p class="text-muted">Scan or enter the receipt barcode/ID. We will locate the transaction and let you load it as a return.</p>
            <div class="input-group mb-2">
                <input type="text" id="returnScanInput" class="form-control" placeholder="Receipt ID (e.g. MOCK-20251104-31F2FC0D)">
                <button id="returnFindBtn" class="btn btn-primary">Find</button>
            </div>
            <div id="returnError" class="text-danger small mb-2" style="display:none;"></div>
            <div id="returnResult" class="border rounded p-2" style="min-height: 60px;">
                <div class="text-muted">No receipt loaded yet.</div>
            </div>
            <div class="d-flex justify-content-end mt-2">
                <button id="returnLoadBtn" class="btn btn-danger" disabled>Load As Return</button>
            </div>
        </div>
    </div>

    <!-- Global Action Footer -->
    <div class="action-footer">
        <div class="container-fluid d-flex align-items-center justify-content-end gap-2">
            <div class="d-none d-sm-flex align-items-center gap-2 me-auto">
                <input type="text" id="barcodeInput" class="form-control form-control-sm" placeholder="Scan or type barcode" autocomplete="off" style="max-width: 240px;">
                <button id="barcodeAddBtn" class="btn btn-outline-primary btn-sm">Add</button>
                <div id="barcodeFeedback" class="barcode-feedback small"></div>
            </div>
            <button id="clearCartBtn" class="btn btn-outline-secondary">Clear Cart</button>
            <button id="checkoutBtn" class="btn btn-primary btn-lg">Checkout</button>
        </div>
    </div>

    <!-- Voucher Scan Overlay -->
    <div id="voucherOverlay" class="search-overlay">
        <div class="search-modal" style="max-width: 560px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Scan Gift Voucher</div>
                <button id="voucherCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <p class="text-muted">Focus the input and scan the voucher barcode, or type it in. Enter the voucher amount to apply.</p>
            <input type="text" id="voucherCodeInput" class="form-control mb-2" placeholder="Voucher barcode" />
            <div class="input-group">
                <span class="input-group-text">Amount</span>
                <input type="number" step="0.01" id="voucherAmountInput" class="form-control" placeholder="e.g. 25.00" />
            </div>
            <div class="d-flex justify-content-end mt-3">
                <button id="voucherSubmitBtn" class="btn btn-primary">Use Voucher</button>
            </div>
        </div>
    </div>

    <!-- Cashier Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-modal">
            <h4 class="mb-3 text-center">Cashier Sign In</h4>
            <div id="loginError" class="text-danger small mb-2" style="display:none;"></div>
            <input type="password" id="cashierCodeInput" class="form-control mb-3" placeholder="Enter code" autocomplete="one-time-code" />
            <div class="keypad-grid">
                <button class="key-btn" data-key="1">1</button>
                <button class="key-btn" data-key="2">2</button>
                <button class="key-btn" data-key="3">3</button>
                <button class="key-btn" data-key="4">4</button>
                <button class="key-btn" data-key="5">5</button>
                <button class="key-btn" data-key="6">6</button>
                <button class="key-btn" data-key="7">7</button>
                <button class="key-btn" data-key="8">8</button>
                <button class="key-btn" data-key="9">9</button>
                <button class="key-btn key-action" data-key="C">C</button>
                <button class="key-btn" data-key="0">0</button>
                <button class="key-btn key-action" data-key="B">Backspace</button>
            </div>
            <button id="loginEnterBtn" class="btn btn-primary w-100 mt-3">Enter</button>
        </div>
    </div>

    <!-- EUR Conversion Overlay Modal -->
    <div id="eurConversionOverlay" class="modal fade eur-conversion-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">EUR Conversion - Select Rate</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted">GBP Total</h6>
                            <h3 id="eurOverlayGbpTotal" class="text-dark">Ã‚Â£0.00</h3>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Store Rate (1 GBP)</h6>
                            <h3 id="eurOverlayStoreRate" class="text-primary">1.00 EUR</h3>
                        </div>
                    </div>
                    <div class="alert alert-info mb-4">
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted">Exact EUR</small>
                                <div id="eurOverlayExact" class="h5 font-monospace">Ã¢â€šÂ¬0.00</div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Round Up (Ã¢â€šÂ¬5)</small>
                                <div id="eurOverlayRoundUp" class="h5 font-monospace">Ã¢â€šÂ¬0.00</div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">Round Down (Ã¢â€šÂ¬5)</small>
                                <div id="eurOverlayRoundDown" class="h5 font-monospace">Ã¢â€šÂ¬0.00</div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <button id="eurSelectRoundUp" class="btn btn-primary btn-lg w-100" onclick="eurApplyRounding('up')">
                                <div>Use Rounded Up</div>
                                <small id="eurSelectRoundUpLabel" class="d-block">Ã¢â€šÂ¬0.00</small>
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button id="eurSelectRoundDown" class="btn btn-success btn-lg w-100" onclick="eurApplyRounding('down')">
                                <div>Use Rounded Down</div>
                                <small id="eurSelectRoundDownLabel" class="d-block">Ã¢â€šÂ¬0.00</small>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Or Enter Custom EUR Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">Ã¢â€šÂ¬</span>
                            <input type="number" id="eurCustomInput" class="form-control form-control-lg" placeholder="0.00" step="0.01" min="0">
                            <button class="btn btn-outline-secondary" onclick="eurApplyCustom()">Apply Custom</button>
                        </div>
                    </div>
                    <div class="alert alert-secondary mt-4">
                        <small class="text-muted">Effective Rate (will be calculated from your selection)</small>
                        <div id="eurEffectiveRateDisplay" class="h6 font-monospace">1 GBP = 1.0000 EUR</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qz-tray/2.2.4/qz-tray.js"></script>
    <script>
        (function(){
            const docEl = document.documentElement;
            window.POS_QZ_CONFIG = {
                certificate: docEl.dataset.qzCertificate || '',
                privateKey: docEl.dataset.qzPrivateKey || ''
            };
        })();
    </script>
    <script src="{{ url_for('static', filename='js/script.js', v='6') }}"></script>
    <script src="{{ url_for('static', filename='js/resume_patch.js', v='2') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap_fix.js', v='1') }}"></script>
</body>
</html>














