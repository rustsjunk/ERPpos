<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERPNext POS</title>
    <link rel="icon" href="data:,">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', v='5') }}">
    
    <!-- Optional: ensure UTF-8 is respected -->
</head>
<body>
    <div class="app-topbar">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
                <div class="brand h5 m-0">POS</div>
            </div>
            <div></div>
            <div class="d-flex align-items-center gap-2">
                <label for="topCustomerSelect" class="visually-hidden">Customer</label><select id="topCustomerSelect" aria-label="Customer" class="customer-select form-select form-select-sm">
                    <option value="">Walk-in Customer</option>
                </select>
                <div class="cashier-wrap">
                    <button id="cashierBadge" class="cashier-badge btn btn-light btn-sm">Not signed in</button>
                    <div id="cashierMenu" class="cashier-menu">
                        <button id="holdBtn" class="btn btn-outline-secondary w-100 mb-2">Hold Transaction</button>
                        <button id="pausedBtn" class="btn btn-outline-primary w-100 mb-2">Paused Transactions</button>
                        <button id="logoutBtn" class="logout-btn">Log Out</button>
                    </div>
                </div>
                <button id="returnFromReceiptBtn" aria-label="Return from receipt" class="icon-btn" title="Return from receipt">↩</button>
                <button id="notifIcon" aria-label="Notifications" class="notif-icon" title="Notifications">&#128276;</button>
                <button id="settingsBtn" aria-label="Settings" class="icon-btn" title="Settings">&#9881;</button>
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row pos-layout">
            <!-- Left side - Items list -->
            <div class="col-md-8">
                <div class="row mb-3">
                    <div class="col">
                        <input type="text" id="itemSearch" aria-label="Search items" class="form-control" placeholder="Search items...">
                    </div>
                </div>
                <div id="itemsGrid" class="row row-cols-1 row-cols-md-3 g-4">
                    <!-- Items will be dynamically added here -->
                </div>
            </div>
            
            <!-- Right side - Cart -->
            <div class="col-md-4 cart-column">
                <div id="cartCard" class="card">
                    <div class="card-header">
                        <h3>Current Cart</h3>
                    </div>
                    <div class="card-body">
                        <div id="cartItems">
                            <!-- Cart items will be dynamically added here -->
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>Total:</h5>
                            <h5 id="cartTotal">0.00</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Removed fixed barcode bar; compact entry lives under cart actions -->

    <!-- Product Search Overlay -->
    <div id="searchOverlay" class="search-overlay">
        <div class="search-modal">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <input type="text" id="searchInputBig" aria-label="Search products" class="form-control me-2" placeholder="Search products..." />
                <label for="brandFilter" class="visually-hidden">Brand filter</label><select id="brandFilter" aria-label="Brand filter" class="form-select" style="max-width:220px"></select>
            </div>
            <div id="searchGrid" class="row row-cols-2 row-cols-md-4 g-3"></div>
            <div class="d-flex justify-content-end mt-3">
                <button id="searchCloseBtn" class="btn btn-outline-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Product Detail Overlay (variant matrix) -->
    <div id="productOverlay" class="search-overlay">
        <div class="search-modal">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0" id="productTitle">Product</div>
                <button id="productCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <div id="productImage" class="product-img"></div>
                    <div id="productBrand" class="mt-2 text-muted"></div>
                    <div id="productPrice" class="fw-semibold mt-1"></div>
                </div>
                <div class="col-12 col-md-8">
                    <div class="table-responsive variant-matrix">
                        <table class="table table-sm align-middle">
                            <thead id="matrixHead"></thead>
                            <tbody id="matrixBody"></tbody>
                        </table>
                    </div>
                    <div class="text-muted small">Click a size cell to add 1 to cart.</div></div></div></div>
    </div>

    <!-- Checkout Overlay -->
    <div id="checkoutOverlay" class="search-overlay">
        <div class="search-modal checkout-modal">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Checkout</div>
                <button id="checkoutCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div class="row g-3">
                <div class="col-12 col-lg-7">
                    <div id="checkoutCart" class="checkout-cart"></div>
                    <div class="mt-3">
                        <div class="mb-2 fw-semibold">Tender Type</div>
                        <div class="tender-grid mb-3">
                            <button id="tenderCashBtn" class="btn tender-btn" data-tender="cash">Cash</button>
                            <button class="btn tender-btn" data-tender="card">Card</button>
                            <button id="tenderVoucherBtn" class="btn tender-btn" data-tender="voucher">Voucher</button>
                            <button class="btn tender-btn" data-tender="other">Other</button>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-5">
                    <div class="tender-panel">
                        <div id="cashSection" class="mb-3" style="display:none;">
                            <div id="cashKeypad" class="keypad-grid compact mt-2" style="display:block;">
                                <button class="key-btn" data-k="7">7</button>
                                <button class="key-btn" data-k="8">8</button>
                                <button class="key-btn" data-k="9">9</button>
                                <button class="key-btn" data-k="4">4</button>
                                <button class="key-btn" data-k="5">5</button>
                                <button class="key-btn" data-k="6">6</button>
                                <button class="key-btn" data-k="1">1</button>
                                <button class="key-btn" data-k="2">2</button>
                                <button class="key-btn" data-k="3">3</button>
                                <button class="key-btn key-action" data-k="C">C</button>
                                <button class="key-btn" data-k="0">0</button>
                                <button class="key-btn key-action" data-k="B">âŒ«</button>
                            </div>
                            <!-- <div class="denom-row mt-2 d-flex flex-wrap gap-2">
                                <button class="btn btn-outline-secondary denom-btn" data-amount="100">Â£100</button>
                                <button class="btn btn-outline-secondary denom-btn" data-amount="50">Â£50</button>
                                <button class="btn btn-outline-secondary denom-btn" data-amount="20">Â£20</button>
                                <button class="btn btn-outline-secondary denom-btn" data-amount="10">Â£10</button>
                                <button class="btn btn-outline-secondary denom-btn" data-amount="5">Â£5</button>
                                <button class="btn btn-outline-secondary denom-btn" data-amount="2">Â£2</button>
                                <button class="btn btn-outline-secondary denom-btn" data-amount="1">Â£1</button>
                                <button class="btn btn-outline-secondary denom-btn" data-amount="0.5">50p</button>
                                <button class="btn btn-outline-secondary denom-btn" data-amount="0.2">20p</button>
                                <button class="btn btn-outline-secondary denom-btn" data-amount="0.1">10p</button>
                                <button class="btn btn-outline-secondary denom-btn" data-amount="0.05">5p</button>
                                <button class="btn btn-outline-secondary denom-btn" data-amount="0.02">2p</button>
                                <button class="btn btn-outline-secondary denom-btn" data-amount="0.01">1p</button>
                            </div> -->
                            <div class="d-flex justify-content-between">
                                <div>Due</div>
                                <div id="amountDue" class="fw-semibold"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div>Cash</div>
                                <div id="amountCash" class="fw-semibold"></div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div>Change</div>
                                <div id="amountChange" class="fw-bold"></div>
                            </div>
                            <div class="cash-controls mt-2 d-flex flex-wrap gap-2 align-items-center justify-content-end">
                                <button id="toggleSubtractBtn" class="btn btn-outline-warning btn-sm">- Mode</button>
                                <input type="number" step="0.01" id="cashInputField" class="form-control form-control-sm" placeholder="Enter cash amount" style="max-width: 160px;" />
                                <button id="toggleKeypadBtn" class="btn btn-outline-secondary btn-sm">Show Keypad</button>
                                <button id="clearCashBtn" class="btn btn-outline-danger btn-sm">Clear</button>
                            </div>
                        </div>
                        <div class="d-grid gap-2 tender-actions">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="fw-semibold text-muted">Amount Due</div>
                                <div id="tenderDue" class="fw-bold"></div>
                            </div>
                            <button id="openDiscountBtn" class="btn btn-outline-secondary">Discount</button>
                            <button id="completeSaleBtn" class="btn btn-success btn-lg">Complete Sale</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Receipt / Print Overlay -->
    <div id="receiptOverlay" class="search-overlay">
        <div class="search-modal receipt-modal">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Sale Complete</div>
                <button id="receiptCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div class="mb-2">Invoice: <span id="receiptInvoice"></span></div>
            <div class="display-6 mb-3">Change: <span id="receiptChange">0.00</span></div>
            <p class="text-muted">Would you like to print the receipt?</p>
            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="giftReceiptCheckbox">
                <label class="form-check-label" for="giftReceiptCheckbox">Also print gift receipt</label>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-3">
                <button id="printReceiptBtn" class="btn btn-primary">Print Receipt</button>
                <button id="receiptDoneBtn" class="btn btn-success">Done</button>
            </div>
        </div>
    </div>

    <!-- Menu Overlay -->
    <div id="menuOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 520px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Menu</div>
                <button id="menuCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div id="menuView">
                <div class="d-grid gap-2">
                    <button id="openSettingsBtn" class="btn btn-light">Settings</button>
                    <button id="reprintLastBtn" class="btn btn-light">Reprint Last Receipt</button>
                    <button id="viewInvoicesBtn" class="btn btn-light" disabled>View Invoices (coming soon)</button>
                    <button id="openAdminBtn" class="btn btn-light">Admin</button>
                </div>
            </div>
            <div id="settingsView" style="display:none;">
                <div class="mb-3">
                    <label for="tillNumberInput" class="form-label">Till Number</label>
                    <input type="text" id="tillNumberInput" class="form-control" placeholder="e.g. TILL-01">
                </div>
                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="darkModeSwitch">
                    <label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
                </div>
                <div class="form-check form-switch mb-4">
                    <input class="form-check-input" type="checkbox" id="autoPrintSwitch">
                    <label class="form-check-label" for="autoPrintSwitch">Auto-print after sale</label>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <button id="settingsBackBtn" class="btn btn-outline-secondary">Back</button>
                    <button id="settingsSaveBtn" class="btn btn-primary">Save</button>
                </div>
            </div>
            <div id="adminView" style="display:none;">
                <div class="mb-2 h6">Admin Tools</div>
                <div class="small text-muted mb-2">Database and sync maintenance</div>
                <div class="d-grid gap-2 mb-3">
                    <button id="adminInitDbBtn" class="btn btn-outline-danger">Initialize Database (schema)</button>
                    <button id="adminSeedBtn" class="btn btn-outline-primary">Seed Demo Items</button>
                    <button id="adminEnsureBtn" class="btn btn-outline-secondary">Ensure Demo DB (init if empty)</button>
                    <button id="adminSyncBtn" class="btn btn-outline-success">Resync from ERPNext</button>
                    <button id="adminStatusBtn" class="btn btn-outline-dark">DB Status</button>
                </div>
                <pre id="adminStatusOut" class="p-2 bg-light" style="max-height: 220px; overflow: auto;"></pre>
                <div class="d-flex justify-content-end gap-2 mt-2">
                    <button id="adminBackBtn" class="btn btn-outline-secondary">Back</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Paused Transactions Overlay -->
    <div id="pausedOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 800px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Paused Transactions</div>
                <button id="pausedCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <div class="table-responsive" style="overflow:auto;">
                <table class="table table-sm align-middle">
                    <thead>
                        <tr>
                            <th>Held At</th>
                            <th>Cashier</th>
                            <th>Customer</th>
                            <th class="text-end">Items</th>
                            <th class="text-end">Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="pausedListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Discount Overlay -->
    <div id="discountOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 900px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Apply Discount</div>
                <button id="discountCloseBtn" class="btn btn-outline-secondary btn-sm">Done</button>
            </div>
            <div class="row g-3">
                <div class="col-12 col-lg-7">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="small text-muted">Select items to discount</div>
                        <div class="btn-group btn-group-sm">
                            <button id="discountSelectAllBtn" class="btn btn-outline-secondary">Select All</button>
                            <button id="discountDeselectAllBtn" class="btn btn-outline-secondary">Deselect All</button>
                        </div>
                    </div>
                    <div id="discountItemsList" class="list-group" style="max-height: 50vh; overflow:auto;"></div>
                </div>
                <div class="col-12 col-lg-5">
                    <div class="card p-3">
                        <div class="mb-2 fw-semibold">Discount Type</div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="discountMode" id="discModeAmount" value="amount" checked>
                            <label class="form-check-label" for="discModeAmount">Amount off (per item)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="discountMode" id="discModePercent" value="percent">
                            <label class="form-check-label" for="discModePercent">Percent off (per item)</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="discountMode" id="discModeSet" value="set">
                            <label class="form-check-label" for="discModeSet">Set unit price</label>
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="discountValueLabel">Value</span>
                            <input type="number" step="0.01" id="discountValueInput" class="form-control" placeholder="e.g. 5.00 or 10 for %">
                        </div>
                        <div class="d-grid">
                            <button id="applyDiscountBtn" class="btn btn-primary">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Return From Receipt Overlay -->
    <div id="returnOverlay" class="search-overlay" style="display:none;">
        <div class="search-modal" style="max-width: 620px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Return From Receipt</div>
                <button id="returnCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <p class="text-muted">Scan or enter the receipt barcode/ID. We will locate the transaction and let you load it as a return.</p>
            <div class="input-group mb-2">
                <input type="text" id="returnScanInput" class="form-control" placeholder="Receipt ID (e.g. MOCK-20251104-31F2FC0D)">
                <button id="returnFindBtn" class="btn btn-primary">Find</button>
            </div>
            <div id="returnError" class="text-danger small mb-2" style="display:none;"></div>
            <div id="returnResult" class="border rounded p-2" style="min-height: 60px;">
                <div class="text-muted">No receipt loaded yet.</div>
            </div>
            <div class="d-flex justify-content-end mt-2">
                <button id="returnLoadBtn" class="btn btn-danger" disabled>Load As Return</button>
            </div>
        </div>
    </div>

    <!-- Global Action Footer -->
    <div class="action-footer">
        <div class="container-fluid d-flex align-items-center justify-content-end gap-2">
            <div class="d-none d-sm-flex align-items-center gap-2 me-auto">
                <input type="text" id="barcodeInput" class="form-control form-control-sm" placeholder="Scan or type barcode" autocomplete="off" style="max-width: 240px;">
                <button id="barcodeAddBtn" class="btn btn-outline-primary btn-sm">Add</button>
                <div id="barcodeFeedback" class="barcode-feedback small"></div>
            </div>
            <button id="clearCartBtn" class="btn btn-outline-secondary">Clear Cart</button>
            <button id="checkoutBtn" class="btn btn-primary btn-lg">Checkout</button>
        </div>
    </div>

    <!-- Voucher Scan Overlay -->
    <div id="voucherOverlay" class="search-overlay">
        <div class="search-modal" style="max-width: 560px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="h5 m-0">Scan Gift Voucher</div>
                <button id="voucherCloseBtn" class="btn btn-outline-secondary btn-sm">Close</button>
            </div>
            <p class="text-muted">Focus the input and scan the voucher barcode, or type it in. Enter the voucher amount to apply.</p>
            <input type="text" id="voucherCodeInput" class="form-control mb-2" placeholder="Voucher barcode" />
            <div class="input-group">
                <span class="input-group-text">Amount</span>
                <input type="number" step="0.01" id="voucherAmountInput" class="form-control" placeholder="e.g. 25.00" />
            </div>
            <div class="d-flex justify-content-end mt-3">
                <button id="voucherSubmitBtn" class="btn btn-primary">Use Voucher</button>
            </div>
        </div>
    </div>

    <!-- Cashier Login Overlay -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-modal">
            <h4 class="mb-3 text-center">Cashier Sign In</h4>
            <div id="loginError" class="text-danger small mb-2" style="display:none;"></div>
            <input type="password" id="cashierCodeInput" class="form-control mb-3" placeholder="Enter code" autocomplete="one-time-code" />
            <div class="keypad-grid">
                <button class="key-btn" data-key="1">1</button>
                <button class="key-btn" data-key="2">2</button>
                <button class="key-btn" data-key="3">3</button>
                <button class="key-btn" data-key="4">4</button>
                <button class="key-btn" data-key="5">5</button>
                <button class="key-btn" data-key="6">6</button>
                <button class="key-btn" data-key="7">7</button>
                <button class="key-btn" data-key="8">8</button>
                <button class="key-btn" data-key="9">9</button>
                <button class="key-btn key-action" data-key="C">C</button>
                <button class="key-btn" data-key="0">0</button>
                <button class="key-btn key-action" data-key="B">Backspace</button>
            </div>
            <button id="loginEnterBtn" class="btn btn-primary w-100 mt-3">Enter</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js', v='5') }}"></script>
    <script src="{{ url_for('static', filename='js/resume_patch.js', v='2') }}"></script>
    <script src="{{ url_for('static', filename='js/bootstrap_fix.js', v='1') }}"></script>
</body>
</html>



